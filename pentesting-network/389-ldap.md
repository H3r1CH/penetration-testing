# 389 (LDAP)

## Enumeration

### Anonymous

#### ldapsearch

New Syntax

```bash
ldapsearch -H ldap://<IP> -x -b "DC=hutch,DC=offsec"
ldapsearch -H ldap://192.168.71.122 -x -b "CN=Users,DC=hutch,DC=offsec"  # Get User info
# Look for any plaintext passwords in the description field
ldapsearch -H "ldap://<IP>" -v -x -b "DC=hutch,DC=offsec" "(objectclass=*)"

# If LAPS is found on the server, can look for admin password
ldapsearch -H ldap://<IP> -v -x -D <USER>@HUTCH.OFFSEC -w <PASS>-b "DC=hutch,DC=offsec" "(ms-MCS-AdmPwd=*)" ms-MCS-AdmPwd
```

Old Syntax

```bash
ldapsearch -h <IP> -x -s base namingcontexts  # Look for the dn: i.e. DC=htb,DC=local
ldapsearch -h <IP> -x -b "DC=htb,DC=local" > ldap-anonymmous.out  # All ldap info we can query as anonymous
ldapsearch -h <IP> -x -s sub -b "DC=htb,DC=local"
ldapsearch -h <IP> -x -b "DC=htb,DC=local" '(objectClass=Person)'  # Look at user info
ldapsearch -h <IP> -x -b "DC=htb,DC=local" '(objectClass=Person)' sAMAccountName
# Grab just the usernames to try and brute force/password spray
ldapsearch -h <IP> -x -b "DC=htb,DC=local" '(objectClass=Person)' sAMAccountName | grep sAMAccountName | awk '{print $2}' > userlist.ldap  # Make it easier to do a password spray
# Can try to check password policy with crackmapexec
crackmapexec smb <IP> --pass-pol -u '' -p ''  # Using null user & passowrd
# Look for 'Account lockout threshold: 0'  # Ideal for brute force
# Brute Force
crackmapexec smb <IP> -u userlist.txt -p pwlist.txt
```

#### nmap

```bash
nmap -n -sV --script "ldap* and not brute" <IP> # Using anonymous credentials
```

### Authenticated

#### ldapdomaindump

```bash
kali@kali:~/ctf/tryhackme/enterprise$ ldapdomaindump 10.10.55.72 -u 'LAB-ENTERPRISE\nik' -p ToastyBoi! -o ldapdomaindumpdir
```
